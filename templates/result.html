<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      href="https://cdn3.emoji.gg/emojis/4063-na-rocket.png"
      type="image/x-icon"
    />
    <title>Analysis Results - TopXðŸ‘¾</title>

    <!-- Local CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Header -->
    <header>
      <a href="/" class="logo">TopXðŸ‘¾-AI Resume Analyzer</a>
      <div>
        <button class="btn btn-secondary" onclick="toggleTheme()">
          <i class="fas fa-moon"></i> Theme
        </button>
        <a href="/" class="btn btn-secondary">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="results-content">
      <h1>Resume Analysis Results</h1>
      <p>Here are the AI-generated insights based on your resume.</p>

      <!-- Marks -->
      <h2><i class="fas fa-graduation-cap"></i> Academic Performance</h2>
      <p>{{ marks }}</p>

      <!-- Potential Companies -->
      <h2><i class="fas fa-building"></i> Potential Companies</h2>
      {% if companies %}
      <ul class="results-list">
        {% for company in companies %}
        <li>
          <span>{{ company }}</span>
          <div class="match-progress">
            <div
              class="match-progress-bar"
              style="width: {{ (70 + loop.index0 * 5) % 100 }}%;"
            ></div>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p>No specific companies identified from the resume.</p>
      {% endif %}

      <!-- Suggested Job Roles -->
      <h2><i class="fas fa-briefcase"></i> Suggested Job Roles</h2>
      {% if job %}
      <ul class="results-list">
        {% for role in job %} {% if role != 'Unknown Role' %}
        <li>
          <span>{{ role }}</span>
          <div class="match-progress">
            <div
              class="match-progress-bar"
              style="width: {{ (60 + loop.index0 * 10) % 100 }}%;"
            ></div>
          </div>
        </li>
        {% endif %} {% endfor %}
      </ul>
      {% if not job|select("ne", "Unknown Role")|list %}
      <p>No specific job roles identified from the resume.</p>
      {% endif %} {% else %}
      <p>No specific job roles identified from the resume.</p>
      {% endif %}

      <!-- Skill Gap Analysis -->
      <h2><i class="fas fa-exclamation-circle"></i> Skill Gap Analysis</h2>
      {% if skill_gaps %}
      <ul class="results-list">
        {% for role, gaps in skill_gaps.items() %}
        <li>
          <span>{{ role }}</span>
          <div>
            {% if gaps %}
            <p>Missing Skills: {{ gaps | join(', ') }}</p>
            {% else %}
            <p>No skill gaps identified for this role.</p>
            {% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p>No skill gaps identified.</p>
      {% endif %}

      <!-- Bio Section -->
      <div class="bio-section">
        <button class="bio-toggle" onclick="toggleBio()">
          <i class="fas fa-info-circle"></i> Understanding Your Results
        </button>
        <div class="bio-content" id="bio-content">
          <p>
            These suggestions are generated by our advanced AI based on your
            resume's content. The match percentages indicate how well your
            skills and experience align with each company or role. The skill gap
            analysis highlights areas to improve for your target roles. Explore
            these opportunities to align with your career goals.
          </p>
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn btn-primary" onclick="downloadResults()">
          Download Results
        </button>
        <a href="/back" class="btn btn-secondary">Upload New</a>
        <button class="btn btn-secondary">More</button>
      </div>
    </main>

    <!-- Footer -->
    <footer>
      <a href="/terms">Terms of use</a>
      <a href="/privacy">Privacy policy</a>
    </footer>

    <script>
            // Pass companies and job data from Flask to JavaScript
            const companies = {{ companies|tojson }};
            const job = {{ job|tojson }};

            // Theme Toggle
            function toggleTheme() {
              document.body.classList.toggle('light-theme');
              const themeIcon = document.querySelector('.btn-secondary i');
              themeIcon.classList.toggle('fa-moon');
              themeIcon.classList.toggle('fa-sun');
              localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
            }

            if (localStorage.getItem('theme') === 'light') {
              document.body.classList.add('light-theme');
              document.querySelector('.btn-secondary i').classList.replace('fa-moon', 'fa-sun');
            }

            // Toggle Bio Section
            function toggleBio() {
              const bioContent = document.getElementById('bio-content');
              bioContent.classList.toggle('expanded');
            }

            // Download Results as PDF
            function downloadResults() {
              const downloadButton = document.querySelector('.btn-primary');
              downloadButton.style.opacity = '0.7';
              downloadButton.disabled = true;
              downloadButton.textContent = 'Downloading...';

              try {
                console.log('Starting download process...');
                console.log('Companies:', companies);
                console.log('Job roles:', job);

                // Generate LaTeX content
                const latexContent = `
      \\documentclass[a4paper,12pt]{article}
      \\usepackage[utf8]{inputenc}
      \\usepackage[T1]{fontenc}
      \\usepackage{lmodern}
      \\usepackage{geometry}
      \\geometry{margin=1in}
      \\usepackage{xcolor}
      \\usepackage{enumitem}
      \\usepackage{titlesec}
      \\usepackage{hyperref}
      \\definecolor{titleblue}{RGB}{0,123,255}
      \\definecolor{accentpink}{RGB}{255,105,180}

      % Title formatting
      \\titleformat{\\section}{\\Large\\bfseries\\color{titleblue}}{\\thesection}{1em}{}
      \\titleformat{\\subsection}{\\large\\bfseries\\color{titleblue}}{\\thesubsection}{1em}{}

      \\begin{document}

      \\begin{center}
        {\\LARGE \\textbf{AI Resume Analyzer Results}}\\\\
        \\vspace{0.5cm}
        {\\small Generated on May 23, 2025 at 03:53 PM IST}
      \\end{center}

      \\vspace{1cm}

      \\section*{Potential Companies}
      ${
        companies && companies.length > 0
          ? companies.map((company, index) => `\\textbf{${company}} \\hfill Match: ${(70 + index * 5) % 100}\\%`).join('\\\\\n')
          : 'No specific companies identified from the resume.'
      }

      \\vspace{0.5cm}

      \\section*{Suggested Job Roles}
      ${
        job && job.length > 0
          ? job
              .filter(role => role !== 'Unknown Role')
              .map((role, index) => `\\textbf{${role}} \\hfill Match: ${(60 + index * 10) % 100}\\%`)
              .join('\\\\\n')
          : 'No specific job roles identified from the resume.'
      }

      \\vspace{0.5cm}

      \\section*{Understanding Your Results}
      These suggestions are generated by our advanced AI based on your resume's content. The match percentages indicate how well your skills and experience align with each company or role. Explore these opportunities to align with your career goals.

      \\end{document}
                `;

                console.log('LaTeX content generated:', latexContent);

                // Create a Blob and trigger download
                const blob = new Blob([latexContent], { type: 'application/x-latex' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'resume_analysis_results.tex';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                console.log('Download triggered successfully');

                // Provide instructions for manual compilation
                alert(
                  'A LaTeX file (resume_analysis_results.tex) has been downloaded. If it does not automatically convert to a PDF, you can compile it to a PDF using a LaTeX editor like Overleaf (https://www.overleaf.com/) or by running the following command in a terminal with LaTeX installed: latexmk -pdf resume_analysis_results.tex'
                );

                // Reset button state
                downloadButton.style.opacity = '1';
                downloadButton.disabled = false;
                downloadButton.textContent = 'Download Results';
              } catch (error) {
                console.error('Error during download:', error);
                downloadButton.style.opacity = '1';
                downloadButton.disabled = false;
                downloadButton.textContent = 'Download Results';
                alert('Failed to download results. Please try again or check the console for errors.');
              }
            }
    </script>
  </body>
</html>
